import React, { useState, useEffect, useRef } from 'react';
import { AlertTriangle, XCircle, Save, FilePlus, Printer, X } from 'lucide-react';

// --- BASE DE DATOS SIMULADA (Datos que el agente podría encontrar) ---
const INITIAL_DB = [
  { id: 1, tipo: 'JURIDICA', denominacion: 'PAPELERA SARANDI S.A.', cuit: '30-11223344-5' },
  { id: 2, tipo: 'FISICA', apellido: 'GOMEZ', nombres: 'JUAN CARLOS', cuit: '20-12345678-9' },
  { id: 3, tipo: 'FISICA', apellido: 'PEREZ', nombres: 'MARIA', cuit: '27-98765432-1' }
];

// --- LISTA NEGRA UIF (Para detonar modales de advertencia) ---
const UIF_BLACKLIST = ['20-99999999-9', '20999999999'];

const App = () => {
  // Estado Global
  const [db, setDb] = useState(INITIAL_DB);
  const [activeTab, setActiveTab] = useState('FISICA'); // FISICA | JURIDICA
  const [statusMsg, setStatusMsg] = useState('Listo.');
  const [modal, setModal] = useState(null); // null | { type: 'ERROR'|'UIF'|'INFO', msg: '' }
  
  // Estado del Buscador
  const [searchTerm, setSearchTerm] = useState('');
  const [isSearching, setIsSearching] = useState(false);
  const [searchResults, setSearchResults] = useState([]);
  
  // Estado de los Formularios
  const [formData, setFormData] = useState({
    apellido: '', nombres: '', tipo_doc: 'DNI', nro_doc: '', cuit: '', 
    f_nac: '', estado_civil: '', nupcias: '', conyuge: '',
    calle: '', numero: '', piso: '', cp: '', localidad: '', email: '',
    denominacion: '', personeria: '', rep_nombre: '', rep_caracter: ''
  });
  
  // Referencias para validación visual
  const errorsRef = useRef({});

  // --- LÓGICA DE NEGOCIO ---

  // 1. El Delay de 3 Segundos (Regla Crítica del Manual)
  useEffect(() => {
    const delayDebounceFn = setTimeout(() => {
      if (searchTerm.length > 2) {
        setIsSearching(true);
        setStatusMsg('Buscando en la base de datos...');
        
        // Simular latencia de red/disco de 1.5s adicionales tras el tipeo
        setTimeout(() => {
          const results = db.filter(item => 
            (item.apellido && item.apellido.includes(searchTerm.toUpperCase())) ||
            (item.denominacion && item.denominacion.includes(searchTerm.toUpperCase())) ||
            item.cuit.includes(searchTerm)
          );
          setSearchResults(results);
          setIsSearching(false);
          setStatusMsg(results.length > 0 ? `${results.length} registros encontrados.` : 'No se encontraron coincidencias.');
        }, 1500);
      } else {
        setSearchResults([]);
        setIsSearching(false);
      }
    }, 3000); // 3 segundos de espera obligatoria según manual

    return () => clearTimeout(delayDebounceFn);
  }, [searchTerm, db]);

  // 2. Manejadores de Inputs
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    
    // Validación UIF en tiempo real (al salir del campo)
    if (name === 'cuit') {
       // Se maneja en onBlur
    }

    setFormData(prev => ({ ...prev, [name]: value.toUpperCase() }));
    
    // Limpiar error visual si existe
    if (errorsRef.current[name]) {
      delete errorsRef.current[name];
    }
  };

  const handleBlurCuit = () => {
    if (UIF_BLACKLIST.includes(formData.cuit)) {
      setModal({
        type: 'UIF',
        title: 'Advertencia del Sistema - UIF',
        msg: 'El CUIT ingresado figura en los listados de Personas Políticamente Expuestas (PEP) o Terrorismo. Debe solicitar documentación respaldatoria adicional.'
      });
    }
  };

  // 3. Guardado y Validaciones
  const handleSave = () => {
    let newErrors = {};
    let isValid = true;

    if (activeTab === 'FISICA') {
      if (!formData.apellido) newErrors.apellido = true;
      if (!formData.nombres) newErrors.nombres = true;
      if (!formData.nro_doc) newErrors.nro_doc = true;
      if (!formData.cuit) newErrors.cuit = true;
      if (!formData.estado_civil) newErrors.estado_civil = true;
      
      // Regla de negocio: Casado requiere Nupcias
      if (['CASADO', 'VIUDO'].includes(formData.estado_civil) && !formData.nupcias) {
        newErrors.nupcias = true;
      }
    } else {
      if (!formData.denominacion) newErrors.denominacion = true;
      if (!formData.cuit) newErrors.cuit = true;
      if (!formData.personeria) newErrors.personeria = true;
    }

    if (Object.keys(newErrors).length > 0) {
      errorsRef.current = newErrors;
      setModal({
        type: 'ERROR',
        title: 'IngedatW',
        msg: 'Faltan ingresar datos obligatorios. Por favor verifique los campos marcados en rojo.'
      });
      setStatusMsg('Error de validación.');
      isValid = false;
    } else {
      // Guardar en "Base de Datos"
      const newItem = activeTab === 'FISICA' 
        ? { id: Date.now(), tipo: 'FISICA', apellido: formData.apellido, nombres: formData.nombres, cuit: formData.cuit }
        : { id: Date.now(), tipo: 'JURIDICA', denominacion: formData.denominacion, cuit: formData.cuit };
      
      setDb(prev => [...prev, newItem]);
      setModal({
        type: 'INFO',
        title: 'Información',
        msg: 'Los datos han sido grabados correctamente.'
      });
      setStatusMsg('Registro guardado exitosamente.');
      handleNew(); // Limpiar
    }
  };

  const handleNew = () => {
    setFormData({
      apellido: '', nombres: '', tipo_doc: 'DNI', nro_doc: '', cuit: '', 
      f_nac: '', estado_civil: '', nupcias: '', conyuge: '',
      calle: '', numero: '', piso: '', cp: '', localidad: '', email: '',
      denominacion: '', personeria: '', rep_nombre: '', rep_caracter: ''
    });
    errorsRef.current = {};
    setSearchTerm('');
    setSearchResults([]);
    setStatusMsg('Listo para nuevo ingreso.');
  };

  // --- RENDERIZADO ---

  return (
    <div className="font-sans text-xs h-screen bg-[#d4d0c8] flex items-center justify-center p-4 select-none">
      
      {/* VENTANA PRINCIPAL */}
      <div className="w-full max-w-4xl h-[90vh] bg-[#ece9d8] border border-[#003c74] shadow-2xl flex flex-col relative">
        
        {/* Barra de Título (Estilo XP) */}
        <div className="bg-gradient-to-b from-[#0058ee] to-[#003c74] text-white px-2 py-1 flex justify-between items-center font-bold shadow-sm">
          <div className="flex items-center gap-2">
            <span className="text-sm">IngedatW - [Ficha de Clientes]</span>
          </div>
          <div className="flex gap-1">
            <button className="w-5 h-5 bg-[#ece9d8] text-black border border-gray-400 flex items-center justify-center rounded-sm hover:bg-white">_</button>
            <button className="w-5 h-5 bg-[#ece9d8] text-black border border-gray-400 flex items-center justify-center rounded-sm hover:bg-white">□</button>
            <button className="w-5 h-5 bg-[#d13438] text-white border border-gray-400 flex items-center justify-center rounded-sm hover:bg-red-600">×</button>
          </div>
        </div>

        {/* Menú */}
        <div className="flex px-2 py-1 border-b border-white gap-3 text-black">
          <span className="underline cursor-pointer hover:bg-[#316ac5] hover:text-white px-1">A</span>rchivo
          <span className="underline cursor-pointer hover:bg-[#316ac5] hover:text-white px-1">E</span>dición
          <span className="underline cursor-pointer hover:bg-[#316ac5] hover:text-white px-1">V</span>er
          <span className="underline cursor-pointer hover:bg-[#316ac5] hover:text-white px-1">H</span>erramientas
          <span className="underline cursor-pointer hover:bg-[#316ac5] hover:text-white px-1">A</span>yuda
        </div>

        {/* Toolbar */}
        <div className="flex p-1 border-b border-[#a0a0a0] gap-1 bg-[#ece9d8]">
          <ToolButton icon={<FilePlus size={14} className="text-green-600"/>} label="Nuevo" onClick={handleNew} />
          <ToolButton icon={<Save size={14} className="text-blue-600"/>} label="Guardar" onClick={handleSave} />
          <div className="w-px bg-gray-400 mx-1"></div>
          <ToolButton icon={<Printer size={14} />} label="Imprimir" disabled />
        </div>

        {/* Área de Búsqueda */}
        <div className="p-3 bg-[#ece9d8] relative">
          <div className="flex flex-col w-1/3">
            <label className="font-bold mb-1">Buscar Cliente (Apellido / CUIT)</label>
            <div className="relative">
                <input 
                  type="text" 
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full border border-[#7f9db9] p-1 h-6 focus:bg-[#ffffe0] outline-none"
                  placeholder="Escriba y espere..."
                />
                {isSearching && (
                   <div className="absolute right-1 top-1 text-blue-600 font-bold text-[10px] animate-pulse">⌛</div>
                )}
            </div>
            {/* Dropdown de Resultados */}
            {searchResults.length > 0 && (
              <div className="absolute top-16 left-3 w-1/3 bg-white border border-gray-600 z-50 shadow-lg max-h-40 overflow-y-auto">
                 <div className="bg-[#000080] text-white px-1 py-0.5 font-bold">Resultados ({searchResults.length})</div>
                 {searchResults.map(item => (
                   <div key={item.id} className="p-1 hover:bg-[#316ac5] hover:text-white cursor-pointer border-b border-dotted border-gray-200">
                      {item.tipo === 'FISICA' 
                        ? `${item.apellido}, ${item.nombres} (${item.cuit})`
                        : `${item.denominacion} (${item.cuit})`
                      }
                   </div>
                 ))}
              </div>
            )}
          </div>
        </div>

        {/* Pestañas */}
        <div className="px-2 flex gap-1 translate-y-[1px] z-10">
          <TabButton label="Personas Físicas" active={activeTab === 'FISICA'} onClick={() => setActiveTab('FISICA')} />
          <TabButton label="Personas Jurídicas" active={activeTab === 'JURIDICA'} onClick={() => setActiveTab('JURIDICA')} />
        </div>

        {/* Panel Principal */}
        <div className="flex-1 bg-[#ece9d8] border border-[#fff] border-t-[#fff] p-3 overflow-y-auto shadow-[inset_2px_2px_0px_#e0e0e0]">
          
          {activeTab === 'FISICA' && (
            <div className="grid grid-cols-12 gap-3">
              {/* Grupo Datos */}
              <FieldSet title="Datos Identificatorios" className="col-span-12 grid grid-cols-12 gap-2">
                 <Input label="Apellido" name="apellido" value={formData.apellido} onChange={handleInputChange} required error={errorsRef.current.apellido} col="col-span-6" autoFocus />
                 <Input label="Nombres" name="nombres" value={formData.nombres} onChange={handleInputChange} required error={errorsRef.current.nombres} col="col-span-6" />
                 
                 <div className="col-span-2">
                   <Label required>Tipo</Label>
                   <select className="w-full border border-[#7f9db9] h-6 text-xs">
                     <option>DNI</option><option>LE</option><option>LC</option>
                   </select>
                 </div>
                 <Input label="Nro. Doc" name="nro_doc" value={formData.nro_doc} onChange={handleInputChange} required error={errorsRef.current.nro_doc} col="col-span-4" />
                 <Input label="CUIT/CUIL/CDI" name="cuit" value={formData.cuit} onChange={handleInputChange} onBlur={handleBlurCuit} required error={errorsRef.current.cuit} col="col-span-3" />
                 <Input label="F. Nacim." name="f_nac" value={formData.f_nac} onChange={handleInputChange} col="col-span-3" placeholder="DD/MM/AAAA" />
              </FieldSet>

              <FieldSet title="Estado Civil & Nupcias" className="col-span-12 grid grid-cols-12 gap-2 bg-[#fffff0]">
                 <div className="col-span-4">
                    <Label required>Estado Civil</Label>
                    <select name="estado_civil" value={formData.estado_civil} onChange={handleInputChange} 
                      className={`w-full border h-6 text-xs ${errorsRef.current.estado_civil ? 'border-red-500 bg-red-50' : 'border-[#7f9db9]'}`}>
                      <option value="">Seleccionar...</option>
                      <option value="SOLTERO">Soltero</option>
                      <option value="CASADO">Casado</option>
                      <option value="VIUDO">Viudo</option>
                      <option value="DIVORCIADO">Divorciado</option>
                    </select>
                 </div>
                 
                 <div className="col-span-2">
                    <Label>Nupcias</Label>
                    <select name="nupcias" value={formData.nupcias} onChange={handleInputChange}
                      disabled={!['CASADO', 'VIUDO'].includes(formData.estado_civil)}
                      className={`w-full border h-6 text-xs ${errorsRef.current.nupcias ? 'border-red-500 bg-red-50' : 'border-[#7f9db9]'} disabled:bg-gray-200`}>
                      <option value="">--</option>
                      <option value="1">1ras</option>
                      <option value="2">2das</option>
                      <option value="3">3ras</option>
                    </select>
                 </div>

                 <Input label="Nombre Cónyuge" name="conyuge" value={formData.conyuge} onChange={handleInputChange} 
                    disabled={!['CASADO', 'VIUDO'].includes(formData.estado_civil)} col="col-span-6" />
              </FieldSet>

              <FieldSet title="Domicilio Real" className="col-span-12 grid grid-cols-12 gap-2">
                 <Input label="Calle" name="calle" value={formData.calle} onChange={handleInputChange} col="col-span-6" />
                 <Input label="Nro" name="numero" value={formData.numero} onChange={handleInputChange} col="col-span-2" />
                 <Input label="Piso/Dpto" name="piso" value={formData.piso} onChange={handleInputChange} col="col-span-2" />
                 <Input label="CP" name="cp" value={formData.cp} onChange={handleInputChange} col="col-span-2" />
                 <Input label="Localidad" name="localidad" value={formData.localidad} onChange={handleInputChange} col="col-span-6" />
                 <Input label="Email (Aviso Web)" name="email" value={formData.email} onChange={handleInputChange} col="col-span-6" />
              </FieldSet>
            </div>
          )}

          {activeTab === 'JURIDICA' && (
             <div className="grid grid-cols-12 gap-3">
                <FieldSet title="Datos Societarios" className="col-span-12 grid grid-cols-12 gap-2">
                  <Input label="Denominación Social" name="denominacion" value={formData.denominacion} onChange={handleInputChange} required error={errorsRef.current.denominacion} col="col-span-8" autoFocus />
                  <Input label="CUIT" name="cuit" value={formData.cuit} onChange={handleInputChange} onBlur={handleBlurCuit} required error={errorsRef.current.cuit} col="col-span-4" />
                </FieldSet>

                <FieldSet title="Personería (Texto para Escritura)" className="col-span-12">
                   <Label required>Texto Completo de Estatutos / Actas</Label>
                   <textarea 
                     name="personeria" 
                     value={formData.personeria} 
                     onChange={handleInputChange}
                     rows={6}
                     className={`w-full border p-1 text-xs font-mono resize-none ${errorsRef.current.personeria ? 'border-red-500 bg-red-50' : 'border-[#7f9db9]'}`}
                   />
                   <p className="text-gray-500 mt-1 italic">* Este campo admite texto largo (Copiar/Pegar)</p>
                </FieldSet>

                <FieldSet title="Representación" className="col-span-12 grid grid-cols-12 gap-2">
                   <Input label="Nombre Representante" name="rep_nombre" value={formData.rep_nombre} onChange={handleInputChange} col="col-span-6" />
                   <Input label="Carácter (Socio/Pte)" name="rep_caracter" value={formData.rep_caracter} onChange={handleInputChange} col="col-span-6" />
                </FieldSet>
             </div>
          )}

        </div>

        {/* Barra de Estado */}
        <div className="bg-[#d4d0c8] border-t border-white p-0.5 flex gap-1 text-[10px] text-gray-700 shadow-[inset_1px_1px_0px_#808080]">
            <div className="border border-gray-500 px-2 w-1/2 bg-[#ece9d8] flex items-center overflow-hidden whitespace-nowrap">
              {statusMsg}
            </div>
            <div className="border border-gray-500 px-2 w-1/6 bg-[#ece9d8] text-center">INS</div>
            <div className="border border-gray-500 px-2 w-1/6 bg-[#ece9d8] text-center">CAPS</div>
            <div className="border border-gray-500 px-2 w-1/6 bg-[#ece9d8] text-center">NUM</div>
        </div>

        {/* --- VENTANAS MODALES --- */}
        {modal && (
          <div className="absolute inset-0 bg-black/20 flex items-center justify-center z-[100]" onClick={() => { /* Bloqueo click fuera */ }}>
            <div className="w-[380px] bg-[#ece9d8] border-[2px] border-white border-r-gray-500 border-b-gray-500 shadow-xl p-1">
              {/* Header Modal */}
              <div className={`px-2 py-1 text-white font-bold flex justify-between items-center text-xs mb-3 
                  ${modal.type === 'ERROR' || modal.type === 'UIF' ? 'bg-gradient-to-r from-red-600 to-red-800' : 'bg-gradient-to-r from-blue-600 to-blue-800'}`}>
                 <span>{modal.title}</span>
                 <X size={14} className="cursor-pointer" onClick={() => setModal(null)}/>
              </div>
              
              {/* Body Modal */}
              <div className="flex gap-4 px-4 py-2">
                 <div className="text-3xl">
                    {modal.type === 'ERROR' && '❌'}
                    {modal.type === 'UIF' && '⚠️'}
                    {modal.type === 'INFO' && 'ℹ️'}
                 </div>
                 <div className="text-xs text-black">
                    {modal.msg}
                 </div>
              </div>

              {/* Footer Modal */}
              <div className="flex justify-center mt-4 mb-2">
                 <button 
                   onClick={() => setModal(null)}
                   className="px-6 py-1 bg-[#ece9d8] border border-black shadow-[1px_1px_0px_white] hover:bg-[#e0e0e0] active:border-gray-500 active:shadow-none"
                   autoFocus
                 >
                   Aceptar
                 </button>
              </div>
            </div>
          </div>
        )}

      </div>
    </div>
  );
};

// --- COMPONENTES REUTILIZABLES DE INTERFAZ ---

const Input = ({ label, name, value, onChange, onBlur, required, error, col, disabled, autoFocus, placeholder }) => (
  <div className={col}>
    <Label required={required}>{label}</Label>
    <input 
      type="text" 
      name={name}
      value={value}
      onChange={onChange}
      onBlur={onBlur}
      disabled={disabled}
      autoFocus={autoFocus}
      placeholder={placeholder}
      className={`w-full border h-6 px-1 text-xs outline-none focus:bg-[#ffffe0] disabled:bg-gray-200 disabled:text-gray-500
        ${error ? 'border-red-500 bg-red-50' : 'border-[#7f9db9]'}`} 
    />
  </div>
);

const Label = ({ children, required }) => (
  <label className="block text-black mb-0.5 select-none">
    {children} {required && <span className="text-red-600">*</span>}
  </label>
);

const FieldSet = ({ title, children, className }) => (
  <div className={`border border-[#d0d0bf] p-2 pt-3 relative mt-2 bg-white ${className}`}>
    <span className="absolute -top-2 left-2 bg-[#ece9d8] px-1 text-[#003c74] font-bold text-[11px] select-none">
      {title}
    </span>
    {children}
  </div>
);

const ToolButton = ({ icon, label, onClick, disabled }) => (
  <button 
    onClick={onClick} 
    disabled={disabled}
    className={`flex items-center gap-1 px-2 py-0.5 border border-transparent rounded-sm text-[11px]
      ${disabled ? 'text-gray-400 cursor-default' : 'hover:bg-[#ffe1c4] hover:border-[#f2ca9d] active:bg-[#ffce96] text-black'}`}
  >
    {icon} {label}
  </button>
);

const TabButton = ({ label, active, onClick }) => (
  <div 
    onClick={onClick}
    className={`px-3 py-1 border-t border-l border-r rounded-t-[3px] cursor-pointer text-[11px] relative top-[1px]
      ${active 
        ? 'bg-[#ece9d8] border-white border-b-0 text-black font-bold z-20 pb-1.5 -mb-px' 
        : 'bg-[#d4d0c8] border-gray-500 text-gray-600 z-0 hover:bg-[#e0dbd3]'}`}
  >
    {label}
  </div>
);

export default App;